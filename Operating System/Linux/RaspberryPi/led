#!/bin/bash

if [ ! -r /sys/class/leds/led1/trigger ]; then
    echo "$(uname -srvmpio) is not supported. This script only works on Raspberry Pi. " >&2
    exit 1
fi

if [ ! -r /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl ]; then
    echo "Ethernet controller LEDs will not be controlled. Download the required source from https://github.com/dumpsite/lan951x-led-ctl" >&2
fi

for (( ; ; )); do
    echo "Checking internet connection to www.google.com..."
    ping -c 1 -W 1 -q "www.google.com" &> /dev/null
    if [ "$?" != "0" ]; then
        echo "No internet connection."
        if [ -x /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl ]; then
            sudo sh -c 'sudo /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl --lnk=1 --spd=1'
        else
            if [ ! -r /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl ]; then
                echo "Unable to find lan951x-led-ctl script. The required script doesn't exist." >&2
            elif [ ! -x /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl ]; then
                echo "Unable to run lan951x-led-ctl script. Please check the permission." >&2
            fi
        fi
        if [ -r /sys/class/leds/led1/trigger ]; then
            sudo sh -c 'echo input > /sys/class/leds/led1/trigger'
        else
            echo "The Raspberry Pi system seems to be corrupted. Unable to access system files." >&2
            exit 2
        fi
    else
        ping -c 1 -W 1 -q "192.168.0.50" &> /dev/null
        if [ "$?" != "0" ]; then
            echo "You have an internet connection. However the printer server is not responding."
            if [ -x /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl ]; then
                sudo sh -c 'sudo /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl --lnk=1 --spd=0'
            else
                if [ ! -r /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl ]; then
                    echo "Unable to find lan951x-led-ctl script. The required script doesn't exist." >&2
                elif [ ! -x /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl ]; then
                    echo "Unable to run lan951x-led-ctl script. Please check the permission." >&2
                fi
            fi
            if [ -r /sys/class/leds/led1/trigger ]; then
                sudo sh -c 'echo panic > /sys/class/leds/led1/trigger'
            else
                echo "The Raspberry Pi system seems to be corrupted. Unable to access system files." >&2
                exit 2
            fi
        else
            echo "You have an internet connection."
            if [ -x /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl ]; then
                sudo sh -c 'sudo /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl --lnk=0 --spd=0'
            else
                if [ ! -r /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl ]; then
                    echo "Unable to find lan951x-led-ctl script. The required script doesn't exist." >&2
                elif [ ! -x /home/pi/.shellscript/lan951x-led-ctl/lan951x-led-ctl ]; then
                    echo "Unable to run lan951x-led-ctl script. Please check the permission." >&2
                fi
            fi
            if [ -r /sys/class/leds/led1/trigger ]; then
                sudo sh -c 'echo panic > /sys/class/leds/led1/trigger'
            else
                echo "The Raspberry Pi system seems to be corrupted. Unable to access system files." >&2
                exit 2
            fi
        fi
    fi

    sleep $(shuf -i 5-15 -n 1)
done

