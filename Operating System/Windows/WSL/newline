#!/bin/bash

if [ $# -eq 0 ]; then
    echo "Usage: newline [options] [<files>]"
    exit 2
elif [ "$1" == "-i" -o "$1" == "--info" ]; then
    params=("$@")
    for i in "${!params[@]}"; do
        if [[ "${params[$i]}" != "-"* ]]; then
            file "${params[$i]}" 2> /dev/null
            xxd -l 64 "${params[$i]}"
        else
            continue
        fi

        if [ $(($#-1)) -ne $i ]; then
            echo ""
        fi
        # echo "index: $i, value: ${params[$i]}, length: $#"
    done
    exit 0
elif [ "$1" == "-h" -o "$1" == "--help" ]; then
    echo 'Determine type of files or converting EOL between LF and CRLF.'
    echo -e '\nUsage: newline [options] [<files>]'
    echo -e '\nOptions: '
    echo -e ' -h, --help\t\tdisplay this help and exit'
    echo -e ' -i, --info FILEs\tdisplay provide file type and properties'
    echo -e ' -q, --quiet\t\tactive quiet mode.'
    echo -e ' -v, --verbose\t\tprint various debugging infomation'
    echo -e '     --type=EOL\t\tlimiting `EOL` type when using converter'
    echo -e '\t\t\t`EOL` only accepted `CRLF` and `LF` (NAK `\\n` or `\\r\\n`)'
    which whiptail &> /dev/null
    if [ $? == 0 ]; then
        echo -e '     --progress\t\tshow progress bar when converting EOL'
    fi
    echo -e ' FILEs\t\t\tconverting files EOL in provided params'
    echo -e '\nEXIT STATUS'
    echo -e ' 0\t operation Successful'
    echo -e ' 1\t operation Failed'
    echo -e ' 2\t unknown command or parameter type'
    echo -e '\nEXAMPLES'
    echo 'Print example.txt file EOL type and properties'
    echo '% newline -i example.txt'
    echo ''
    echo 'Convert example.txt file other support EOL type'
    echo '% newline example.txt'
    echo ''
    echo 'Convert example.txt file EOL type to CRLF'
    echo '% newline --type=CRLF example.txt'
    echo ''
    exit 0
fi

params=("$@")
for i in "${!params[@]}"; do
    if [[ "${params[$i]}" == "-"* ]]; then
        continue
    fi

    file -b "${params[$i]}" 2> /dev/null | grep "text" 2> /dev/null | grep "CRLF" &> /dev/null
    if [ $? == 0 ]; then
        sed -i 's/\r$//' "${params[$i]}" &> /dev/null
        if [ $? == 0 ]; then
            echo "${params[$i]}: operation complete. EOL was converted CRLF to LF."
        else
            echo "unable to convert ${params[$i]} file. reason: access denied.">&2
        fi
        continue
    fi

    file -b "${params[$i]}" 2> /dev/null | grep "text" 2> /dev/null | grep "CR" &> /dev/null
    if [ $? == 0 ]; then
        echo "unable to convert ${params[$i]} file. reason: unsupported EOL CR(Macintosh) type.">&2
        continue
    fi

    file -b "${params[$i]}" 2> /dev/null | grep "text" &> /dev/null
    if [ $? == 0 ]; then
        sed -i 's/$/\r/' "${params[$i]}" &> /dev/null
        if [ $? == 0 ]; then
            echo "${params[$i]}: operation complete. EOL was converted LF to CRLF."
        else
            echo "unable to convert ${params[$i]} file. reason: access denied.">&2
        fi
        continue
    fi
done

